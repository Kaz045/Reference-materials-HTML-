<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ブラウザのセキュリティとfile://問題の解説</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #475569;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #ca8a04;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
        }

        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 40px;
            font-size: 2rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--primary);
        }

        .card h2 {
            margin-top: 0;
            color: var(--secondary);
            font-size: 1.4rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .highlight {
            background-color: #eff6ff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
            color: var(--primary);
        }

        /* Comparison Section */
        .comparison {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .comp-box {
            flex: 1;
            padding: 20px;
            border-radius: 8px;
            min-width: 280px;
        }
        .comp-http {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
        }
        .comp-file {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
        }
        .comp-title {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 10px;
            display: block;
        }
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: white;
            font-weight: bold;
        }
        .tag-safe { background-color: var(--success); }
        .tag-danger { background-color: var(--danger); }

        /* Icon styling */
        .icon { font-size: 1.5rem; }

        /* List styling */
        ul { margin: 0; padding-left: 20px; }
        li { margin-bottom: 8px; }

        /* Story Flow */
        .story-step {
            position: relative;
            padding-left: 30px;
            margin-bottom: 15px;
        }
        .story-step::before {
            content: "▼";
            position: absolute;
            left: 0;
            color: var(--primary);
        }

        /* Summary Box */
        .summary-box {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
        }
        .summary-text {
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .comparison { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Webブラウザのセキュリティと<br>「file://」問題の解説</h1>

    <div class="card">
        <h2><span class="icon">🛡️</span> 1. そもそもブラウザは何を守っているのか？</h2>
        <p>ブラウザは単なる「ビューア（閲覧ソフト）」ではなく、<strong>「危険なこともできてしまう実行環境」</strong>です。</p>
        <div class="highlight">
            もしセキュリティが甘いと…<br>
            PC内の「請求書」や「顧客名簿」を勝手に読み取られ、外部へ送信されてしまう恐れがあります。
        </div>
        <p>そのため、ブラウザは<strong>「Origin（出どころ）」</strong>という考え方で、ページを厳しい「箱（縄張り）」に閉じ込めています。</p>
    </div>

    <div class="card" style="border-left-color: var(--warning);">
        <h2><span class="icon">📦</span> 2. 「Origin（出どころ）」って何？</h2>
        <p>「出どころごとに別の箱に閉じ込め、他の箱に手を出させない」ための単位です。<br>
        Originは主に以下の3つで決まります。</p>
        <ul>
            <li><strong>プロトコル</strong> (http / https / file など)</li>
            <li><strong>ドメイン</strong> (example.com / localhost)</li>
            <li><strong>ポート</strong> (:80 / :8000 など)</li>
        </ul>
    </div>

    <div class="card">
        <h2><span class="icon">🆚</span> 3. 「http://localhost」と「file://」の違い</h2>
        <p>見た目は似ていても、ブラウザにとっては全くの別物です。</p>
        
        <div class="comparison">
            <div class="comp-box comp-http">
                <span class="comp-title"><span class="tag tag-safe">安全</span> http://localhost</span>
                <p><strong>例え：会社の会議室</strong></p>
                <ul>
                    <li>利用ルールが決まっている場所。</li>
                    <li>出どころが明確。</li>
                    <li>JSが他のファイルを読み込むルールが整っている。</li>
                </ul>
            </div>
            <div class="comp-box comp-file">
                <span class="comp-title"><span class="tag tag-danger">警戒</span> file://</span>
                <p><strong>例え：個人の机の引き出し</strong></p>
                <ul>
                    <li>中身は超機密かもしれない場所。</li>
                    <li>ブラウザは警戒し、勝手な動作を制限する。</li>
                    <li>Originが "null" (身元不明) 扱いになることがある。</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="card" style="border-left-color: var(--danger);">
        <h2><span class="icon">🚫</span> 4. file:// だと何が動かないのか</h2>
        <p>今回の症状（ボタンが動かない）に関係するのは、主に以下の制限です。</p>
        
        <h3>(A) 他ファイルの読み込みブロック</h3>
        <p>Webアプリは通常、JSファイルや追加データを分割して読み込みます。しかし <code>file://</code> では、これが<strong>「ローカルPC内の別ファイルへの不正アクセス」</strong>とみなされ、ブラウザがブロックします。</p>
        
        <h3>(B) PDF.js の Worker（別スレッド）</h3>
        <p>重いPDF処理を軽くするための「Worker」機能も、別のファイルをロードする必要があるため、<code>file://</code> では失敗しやすくなります。</p>
    </div>

    <div class="card">
        <h2><span class="icon">🧩</span> 5. なぜ今回この構成（ES Modules）なのか</h2>
        <p><strong>ES Modules (ESM)</strong> は、プログラムを機能ごとに分割して整理する仕組みです。</p>
        <ul>
            <li><strong>メリット：</strong> 設計の見通しが良くなり、品質・保守性が上がる。（今回の「座標変換」や「PDF処理」の分離に必須）</li>
            <li><strong>デメリット：</strong> 裏側で「他ファイルの読み込み」が必須となるため、<code>file://</code> の制限に引っかかる。</li>
        </ul>
        <p>つまり、<strong>「品質の高い設計を選んだ結果、file:// の制限と衝突した」</strong>というのが実情です。</p>
    </div>

    <div class="card" style="border-left-color: var(--success);">
        <h2><span class="icon">✅</span> 6. 「ローカル完結」は達成できています</h2>
        <p>ここの誤解を解くことが重要です。</p>
        <div class="comparison">
            <div class="comp-box comp-http">
                <span class="comp-title">データセキュリティの観点</span>
                <p><strong>⭕ 達成済み</strong></p>
                <p>データは外に出ず、サーバーにも保存されません。PDF読み込みから出力まで、すべてPC内で完結しています。</p>
            </div>
            <div class="comp-box comp-file" style="border-color: #cbd5e1; background-color: #f8fafc;">
                <span class="comp-title">起動方式の観点</span>
                <p><strong>❌ ダブルクリック起動は困難</strong></p>
                <p>「データが外に出ないか」と「file://（ダブルクリック）で動くか」は別の話です。高度な機能を使うため、ブラウザの安全装置が働いています。</p>
            </div>
        </div>
    </div>

    <div class="card">
        <h2><span class="icon">🎬</span> 7. 今回起きたことの全体像</h2>
        <div class="story-step">品質向上のため、モジュール分割（ESM）を採用した設計にした。</div>
        <div class="story-step">PDF処理高速化のため、Workerを採用した（自然な選択）。</div>
        <div class="story-step">開発中（http://localhost）はルール通りなので問題なく動いた。</div>
        <div class="story-step"><strong>完成品を <code>file://</code> で開いた瞬間、ブラウザが「PC内ファイルへの自由アクセス」を警戒。</strong></div>
        <div class="story-step">ファイルの読み込みがブロックされ、初期化が止まり、「ボタンが動かない」状態になった。</div>
    </div>

    <div class="summary-box">
        <h2>💡 ひとことで言うと</h2>
        <p class="summary-text">
            Web技術は「住所（http://〜）」がある前提で安全に作られており、<br>
            file:// は住所がない「身元不明」扱いになるため、<br>
            セキュリティのために機能が制限されてしまいます。
        </p>
    </div>

</div>

</body>
</html>